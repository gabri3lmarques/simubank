{"ast":null,"code":"// src/app/bank.service.ts\nimport { signal, computed } from '@angular/core';\nimport { of } from 'rxjs';\nimport { tap, map, switchMap } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"@angular/router\";\nexport class BankService {\n  constructor(http, router) {\n    this.http = http;\n    this.router = router;\n    this.apiUrl = 'http://localhost:3000'; // json-server default port\n    // State management with Signals\n    this.currentUser = signal(null);\n    this.userTransactions = signal([]);\n    this.isAuthenticated = computed(() => !!this.currentUser());\n    // Attempt to load user from session storage on service initialization\n    this.loadUserFromSessionStorage();\n  }\n  loadUserFromSessionStorage() {\n    const storedUser = sessionStorage.getItem('currentUser');\n    if (storedUser) {\n      this.currentUser.set(JSON.parse(storedUser));\n      // Optionally fetch transactions if user is already logged in\n      this.fetchTransactions(this.currentUser().id).subscribe();\n    }\n  }\n  login(accountId, password) {\n    return this.http.get(`${this.apiUrl}/users?id=${accountId}&password=${password}`).pipe(tap(users => {\n      if (users.length > 0) {\n        const user = users[0];\n        this.currentUser.set(user);\n        sessionStorage.setItem('currentUser', JSON.stringify(user));\n        this.fetchTransactions(user.id).subscribe();\n        this.router.navigate(['/dashboard']);\n      } else {\n        alert('Invalid Account ID or Password');\n      }\n    }));\n  }\n  logout() {\n    this.currentUser.set(null);\n    this.userTransactions.set([]);\n    sessionStorage.removeItem('currentUser');\n    this.router.navigate(['/login']);\n  }\n  register(name, accountId, password) {\n    return this.checkUserExists(accountId).pipe(switchMap(exists => {\n      if (exists) {\n        alert('Account ID already exists. Please choose another.');\n        return of(null);\n      }\n      const newUser = {\n        id: accountId,\n        password: password,\n        name: name,\n        balance: 0\n      };\n      return this.http.post(`${this.apiUrl}/users`, newUser).pipe(tap(user => {\n        // Automatically log in the new user\n        this.currentUser.set(user);\n        sessionStorage.setItem('currentUser', JSON.stringify(user));\n        this.router.navigate(['/dashboard']);\n      }));\n    }));\n  }\n  checkUserExists(accountId) {\n    return this.http.get(`${this.apiUrl}/users?id=${accountId}`).pipe(map(users => users.length > 0));\n  }\n  fetchTransactions(userId) {\n    return this.http.get(`${this.apiUrl}/transactions?userId=${userId}&_sort=date&_order=desc`).pipe(tap(transactions => this.userTransactions.set(transactions)));\n  }\n  deposit(amount) {\n    const user = this.currentUser();\n    if (!user) throw new Error('No user logged in.');\n    const newBalance = user.balance + amount;\n    return this.updateUserBalance(user.id, newBalance).pipe(tap(updatedUser => {\n      this.currentUser.set(updatedUser);\n      sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));\n      this.addTransaction(user.id, 'deposit', amount).subscribe();\n    }), map(() => user) // Return the original user or updated user if needed\n    );\n  }\n  withdraw(amount) {\n    const user = this.currentUser();\n    if (!user) throw new Error('No user logged in.');\n    if (user.balance < amount) {\n      alert('Insufficient balance.');\n      throw new Error('Insufficient balance.');\n    }\n    const newBalance = user.balance - amount;\n    return this.updateUserBalance(user.id, newBalance).pipe(tap(updatedUser => {\n      this.currentUser.set(updatedUser);\n      sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));\n      this.addTransaction(user.id, 'withdrawal', amount).subscribe();\n    }), map(() => user) // Return the original user or updated user if needed\n    );\n  }\n  updateUserBalance(userId, newBalance) {\n    return this.http.patch(`${this.apiUrl}/users/${userId}`, {\n      balance: newBalance\n    });\n  }\n  addTransaction(userId, type, amount) {\n    const newTransaction = {\n      userId,\n      type,\n      amount,\n      date: new Date().toISOString()\n    };\n    return this.http.post(`${this.apiUrl}/transactions`, newTransaction).pipe(tap(transaction => {\n      this.userTransactions.update(transactions => [transaction, ...transactions]);\n    }));\n  }\n  static {\n    this.ɵfac = function BankService_Factory(t) {\n      return new (t || BankService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.Router));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: BankService,\n      factory: BankService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}","map":{"version":3,"names":["signal","computed","of","tap","map","switchMap","BankService","constructor","http","router","apiUrl","currentUser","userTransactions","isAuthenticated","loadUserFromSessionStorage","storedUser","sessionStorage","getItem","set","JSON","parse","fetchTransactions","id","subscribe","login","accountId","password","get","pipe","users","length","user","setItem","stringify","navigate","alert","logout","removeItem","register","name","checkUserExists","exists","newUser","balance","post","userId","transactions","deposit","amount","Error","newBalance","updateUserBalance","updatedUser","addTransaction","withdraw","patch","type","newTransaction","date","Date","toISOString","transaction","update","i0","ɵɵinject","i1","HttpClient","i2","Router","factory","ɵfac","providedIn"],"sources":["/home/gabe/Projects/bank-app/src/app/bank.service.ts"],"sourcesContent":["// src/app/bank.service.ts\nimport { Injectable, signal, computed } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { Router } from '@angular/router';\nimport { Observable, of } from 'rxjs';\nimport { tap, map, switchMap } from 'rxjs/operators';\nimport { User, Transaction } from './models';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class BankService {\n  private apiUrl = 'http://localhost:3000'; // json-server default port\n\n  // State management with Signals\n  currentUser = signal<User | null>(null);\n  userTransactions = signal<Transaction[]>([]);\n  isAuthenticated = computed(() => !!this.currentUser());\n\n  constructor(private http: HttpClient, private router: Router) {\n    // Attempt to load user from session storage on service initialization\n    this.loadUserFromSessionStorage();\n  }\n\n  private loadUserFromSessionStorage(): void {\n    const storedUser = sessionStorage.getItem('currentUser');\n    if (storedUser) {\n      this.currentUser.set(JSON.parse(storedUser));\n      // Optionally fetch transactions if user is already logged in\n      this.fetchTransactions(this.currentUser()!.id).subscribe();\n    }\n  }\n\n  login(accountId: string, password: string): Observable<User[]> {\n    return this.http.get<User[]>(`${this.apiUrl}/users?id=${accountId}&password=${password}`)\n      .pipe(\n        tap(users => {\n          if (users.length > 0) {\n            const user = users[0];\n            this.currentUser.set(user);\n            sessionStorage.setItem('currentUser', JSON.stringify(user));\n            this.fetchTransactions(user.id).subscribe();\n            this.router.navigate(['/dashboard']);\n          } else {\n            alert('Invalid Account ID or Password');\n          }\n        })\n      );\n  }\n\n  logout(): void {\n    this.currentUser.set(null);\n    this.userTransactions.set([]);\n    sessionStorage.removeItem('currentUser');\n    this.router.navigate(['/login']);\n  }\n\n  register(name: string, accountId: string, password: string): Observable<User | null> {\n    return this.checkUserExists(accountId).pipe(\n      switchMap(exists => {\n        if (exists) {\n          alert('Account ID already exists. Please choose another.');\n          return of(null);\n        }\n\n        const newUser: User = {\n          id: accountId,\n          password: password,\n          name: name,\n          balance: 0\n        };\n\n        return this.http.post<User>(`${this.apiUrl}/users`, newUser).pipe(\n          tap(user => {\n            // Automatically log in the new user\n            this.currentUser.set(user);\n            sessionStorage.setItem('currentUser', JSON.stringify(user));\n            this.router.navigate(['/dashboard']);\n          })\n        );\n      })\n    );\n  }\n\n  private checkUserExists(accountId: string): Observable<boolean> {\n    return this.http.get<User[]>(`${this.apiUrl}/users?id=${accountId}`).pipe(\n      map(users => users.length > 0)\n    );\n  }\n\n  fetchTransactions(userId: string): Observable<Transaction[]> {\n    return this.http.get<Transaction[]>(`${this.apiUrl}/transactions?userId=${userId}&_sort=date&_order=desc`)\n      .pipe(\n        tap(transactions => this.userTransactions.set(transactions))\n      );\n  }\n\n  deposit(amount: number): Observable<User> {\n    const user = this.currentUser();\n    if (!user) throw new Error('No user logged in.');\n\n    const newBalance = user.balance + amount;\n    return this.updateUserBalance(user.id, newBalance).pipe(\n      tap(updatedUser => {\n        this.currentUser.set(updatedUser);\n        sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));\n        this.addTransaction(user.id, 'deposit', amount).subscribe();\n      }),\n      map(() => user) // Return the original user or updated user if needed\n    );\n  }\n\n  withdraw(amount: number): Observable<User> {\n    const user = this.currentUser();\n    if (!user) throw new Error('No user logged in.');\n\n    if (user.balance < amount) {\n      alert('Insufficient balance.');\n      throw new Error('Insufficient balance.');\n    }\n\n    const newBalance = user.balance - amount;\n    return this.updateUserBalance(user.id, newBalance).pipe(\n      tap(updatedUser => {\n        this.currentUser.set(updatedUser);\n        sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));\n        this.addTransaction(user.id, 'withdrawal', amount).subscribe();\n      }),\n      map(() => user) // Return the original user or updated user if needed\n    );\n  }\n\n  private updateUserBalance(userId: string, newBalance: number): Observable<User> {\n    return this.http.patch<User>(`${this.apiUrl}/users/${userId}`, { balance: newBalance });\n  }\n\n  private addTransaction(userId: string, type: 'deposit' | 'withdrawal', amount: number): Observable<Transaction> {\n    const newTransaction: Omit<Transaction, 'id'> = {\n      userId,\n      type,\n      amount,\n      date: new Date().toISOString()\n    };\n    return this.http.post<Transaction>(`${this.apiUrl}/transactions`, newTransaction).pipe(\n      tap(transaction => {\n        this.userTransactions.update(transactions => [transaction, ...transactions]);\n      })\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}